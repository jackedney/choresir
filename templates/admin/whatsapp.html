{% extends "admin/base.html" %}

{% block title %}WhatsApp Setup{% endblock %}

{% block content %}
<h1>WhatsApp Setup</h1>

<nav aria-label="breadcrumb" style="margin-bottom: 1rem;">
    <a href="/admin">&larr; Back to Dashboard</a>
</nav>

<article>
    <header>
        <h3>Connection Status</h3>
    </header>

    <div id="status-container">
        <p>Checking connection status...</p>
    </div>

    <div id="qr-container" style="text-align: center; display: none;">
        <p><strong>Scan this QR code with WhatsApp:</strong></p>
        <p style="color: var(--muted-color); font-size: 0.9rem;">
            Open WhatsApp &rarr; Settings &rarr; Linked Devices &rarr; Link a Device
        </p>
        <img id="qr-image" src="" alt="WhatsApp QR Code" style="max-width: 300px; margin: 1rem auto;">
        <p style="color: var(--muted-color); font-size: 0.85rem;">
            QR code refreshes automatically every 20 seconds
        </p>
    </div>

    <div id="connected-container" style="display: none;">
        <p style="color: #22c55e; font-weight: bold;">
            &#10003; WhatsApp Connected
        </p>
        <p>Connected as: <strong id="connected-phone"></strong></p>
        <div id="webhook-status"></div>
    </div>

    <div id="error-container" style="display: none;">
        <p style="color: #dc2626;">
            &#10007; Connection Error
        </p>
        <p id="error-message"></p>
        <button onclick="checkStatus()" class="secondary">Retry</button>
    </div>
</article>

<article>
    <header>
        <h3>House Group Chat</h3>
    </header>

    <p style="color: var(--muted-color); font-size: 0.9rem; margin-bottom: 1rem;">
        Configure ChoresSir to respond in a house group chat instead of individual DMs.
        When a group is configured, the bot will ONLY respond in that group and ignore personal messages.
    </p>

    <div id="group-config-container">
        <div id="group-config-status">Loading group configuration...</div>

        <form id="group-config-form" style="display: none; margin-top: 1rem;">
            <label for="group-chat-id">
                Group Chat ID
                <input type="text" id="group-chat-id" name="group_chat_id"
                       placeholder="e.g., 120363400136168625@g.us"
                       style="font-family: monospace;">
            </label>
            <p style="color: var(--muted-color); font-size: 0.85rem; margin-top: -0.5rem;">
                Leave empty to respond to DMs only (default behavior)
            </p>
            <button type="submit">Save Group Configuration</button>
        </form>

        <div id="group-config-message" style="display: none; margin-top: 1rem;"></div>
    </div>

    <details style="margin-top: 1rem;">
        <summary>How to find your Group ID</summary>
        <ol style="margin-top: 0.5rem; padding-left: 1.5rem;">
            <li>Create or open the WhatsApp group you want ChoresSir to use</li>
            <li>Send any message in the group</li>
            <li>Check the application logs - the group ID will appear in the format <code>120363400136168625@g.us</code></li>
            <li>Copy the full group ID (including @g.us) and paste it above</li>
        </ol>
    </details>
</article>

<article>
    <header>
        <h3>Troubleshooting</h3>
    </header>
    <ul>
        <li>Make sure the WAHA service is running (<code>docker-compose up -d waha</code>)</li>
        <li>The QR code expires quickly - scan it within 20 seconds</li>
        <li>If the QR code doesn't appear, try refreshing the page</li>
        <li>Only one WhatsApp account can be linked at a time</li>
    </ul>
</article>

<script>
let statusCheckInterval;
let qrRefreshInterval;

async function checkStatus() {
    const statusContainer = document.getElementById('status-container');
    const qrContainer = document.getElementById('qr-container');
    const connectedContainer = document.getElementById('connected-container');
    const errorContainer = document.getElementById('error-container');

    try {
        const response = await fetch('/admin/whatsapp/status');
        const data = await response.json();

        statusContainer.style.display = 'none';
        qrContainer.style.display = 'none';
        connectedContainer.style.display = 'none';
        errorContainer.style.display = 'none';

        if (data.status === 'WORKING') {
            connectedContainer.style.display = 'block';
            document.getElementById('connected-phone').textContent = data.phone || 'Unknown';
            clearInterval(qrRefreshInterval);
            clearInterval(statusCheckInterval);

            // Show webhook status
            const webhookStatus = document.getElementById('webhook-status');
            if (data.webhook_configured) {
                webhookStatus.innerHTML = `
                    <p style="color: #22c55e;">&#10003; Webhook configured</p>
                    <p style="color: var(--muted-color); font-size: 0.9rem;">
                        Ready to receive messages.
                    </p>
                `;
            } else {
                webhookStatus.innerHTML = `
                    <p style="color: #eab308;">&#9888; Webhook not configured</p>
                    <p style="color: var(--muted-color); font-size: 0.9rem;">
                        Messages won't be received until webhook is configured.
                    </p>
                    <button onclick="configureWebhook()">Configure Webhook</button>
                `;
            }
        } else if (data.status === 'SCAN_QR_CODE') {
            qrContainer.style.display = 'block';
            loadQRCode();
            // Start QR refresh if not already running
            if (!qrRefreshInterval) {
                qrRefreshInterval = setInterval(loadQRCode, 20000);
            }
        } else if (data.status === 'STARTING') {
            statusContainer.style.display = 'block';
            statusContainer.innerHTML = '<p>Session is starting... please wait.</p>';
        } else if (data.status === 'STOPPED' || data.status === 'NOT_FOUND') {
            statusContainer.style.display = 'block';
            statusContainer.innerHTML = `
                <p>WhatsApp session is not running.</p>
                <button onclick="startSession()">Start Session</button>
            `;
            clearInterval(qrRefreshInterval);
            qrRefreshInterval = null;
        } else {
            statusContainer.style.display = 'block';
            statusContainer.innerHTML = '<p>Status: ' + data.status + '</p>';
        }
    } catch (error) {
        statusContainer.style.display = 'none';
        qrContainer.style.display = 'none';
        connectedContainer.style.display = 'none';
        errorContainer.style.display = 'block';
        document.getElementById('error-message').textContent =
            'Could not connect to WAHA service. Make sure it is running.';
    }
}

async function loadQRCode() {
    const qrImage = document.getElementById('qr-image');
    // Add timestamp to prevent caching
    qrImage.src = '/admin/whatsapp/qr?' + new Date().getTime();
}

async function startSession() {
    try {
        const response = await fetch('/admin/whatsapp/start', { method: 'POST' });
        if (response.ok) {
            // Wait a moment for session to initialize
            setTimeout(checkStatus, 2000);
        }
    } catch (error) {
        console.error('Failed to start session:', error);
    }
}

async function configureWebhook() {
    const webhookStatus = document.getElementById('webhook-status');
    webhookStatus.innerHTML = '<p>Configuring webhook...</p>';

    try {
        const response = await fetch('/admin/whatsapp/configure-webhook', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            webhookStatus.innerHTML = `
                <p style="color: #22c55e;">&#10003; Webhook configured successfully!</p>
                <p style="color: var(--muted-color); font-size: 0.9rem;">
                    Session is restarting... please wait.
                </p>
            `;
            // Restart polling to detect when session is back
            statusCheckInterval = setInterval(checkStatus, 5000);
        } else {
            webhookStatus.innerHTML = `
                <p style="color: #dc2626;">&#10007; Failed to configure webhook</p>
                <p>${data.error || 'Unknown error'}</p>
                <button onclick="configureWebhook()" class="secondary">Retry</button>
            `;
        }
    } catch (error) {
        webhookStatus.innerHTML = `
            <p style="color: #dc2626;">&#10007; Failed to configure webhook</p>
            <p>${error.message}</p>
            <button onclick="configureWebhook()" class="secondary">Retry</button>
        `;
    }
}

// Group configuration functions
async function loadGroupConfig() {
    const statusDiv = document.getElementById('group-config-status');
    const form = document.getElementById('group-config-form');
    const input = document.getElementById('group-chat-id');

    try {
        const response = await fetch('/admin/whatsapp/group-config');
        const data = await response.json();

        statusDiv.style.display = 'none';
        form.style.display = 'block';

        if (data.group_chat_id) {
            input.value = data.group_chat_id;
            statusDiv.innerHTML = `
                <p style="color: #22c55e;">&#10003; Group configured: <code>${data.group_chat_id}</code></p>
                <p style="color: var(--muted-color); font-size: 0.9rem;">
                    Bot will respond ONLY in this group (DMs ignored)
                </p>
            `;
            statusDiv.style.display = 'block';
        } else {
            statusDiv.innerHTML = `
                <p style="color: var(--muted-color);">No group configured - responding to DMs only</p>
            `;
            statusDiv.style.display = 'block';
        }
    } catch (error) {
        statusDiv.textContent = 'Failed to load group configuration';
        statusDiv.style.color = '#dc2626';
    }
}

async function saveGroupConfig(event) {
    event.preventDefault();

    const input = document.getElementById('group-chat-id');
    const messageDiv = document.getElementById('group-config-message');
    const formData = new FormData();
    formData.append('group_chat_id', input.value.trim());

    messageDiv.style.display = 'block';
    messageDiv.innerHTML = '<p>Saving...</p>';

    try {
        const response = await fetch('/admin/whatsapp/group-config', {
            method: 'POST',
            body: formData,
        });
        const data = await response.json();

        if (data.success) {
            messageDiv.innerHTML = `<p style="color: #22c55e;">&#10003; ${data.message}</p>`;
            // Reload to refresh the status display
            setTimeout(loadGroupConfig, 1000);
        } else {
            messageDiv.innerHTML = `<p style="color: #dc2626;">&#10007; ${data.error}</p>`;
        }
    } catch (error) {
        messageDiv.innerHTML = `<p style="color: #dc2626;">&#10007; ${error.message}</p>`;
    }
}

// Set up form handler
document.getElementById('group-config-form').addEventListener('submit', saveGroupConfig);

// Initial checks
checkStatus();
loadGroupConfig();

// Poll status every 5 seconds
statusCheckInterval = setInterval(checkStatus, 5000);
</script>
{% endblock %}
