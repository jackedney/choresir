{
  "version": 1,
  "project": "Code Review Issue Fixes",
  "overview": "Implement all fixes identified in code review PR #64, Review #3740736569. This includes security fixes, input validation, code cleanup, logging consistency, cache management, and test improvements across the codebase.",
  "goals": [
    "Fix security issue: remove PII (phone numbers) from admin notifications",
    "Improve input validation: reject non-positive recurrence intervals",
    "Remove unreachable code and clean up codebase",
    "Standardize logging style to use structured logging throughout",
    "Add proper type hints to test fixtures and parameters",
    "Replace unbounded caches with bounded LRU caches",
    "Fix test inconsistencies and remove database mocking"
  ],
  "nonGoals": [
    "No new features or functionality changes",
    "No architectural redesigns",
    "No performance optimizations beyond cache bounding"
  ],
  "successMetrics": [
    "All 20+ code review suggestions implemented",
    "Quality gates pass (ruff format, ruff check, ty check, pytest)",
    "No PII in logs or admin notifications",
    "All cache decorators are bounded with lru_cache",
    "Consistent structured logging style throughout codebase"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "FastAPI",
    "hosting": "N/A",
    "database": "PocketBase",
    "auth": "N/A"
  },
  "routes": [],
  "uiNotes": [],
  "dataModel": [],
  "importFormat": {
    "description": "Not applicable",
    "example": {}
  },
  "rules": [
    "Always use @functools.lru_cache with maxsize instead of unbounded @functools.cache",
    "Always strip input before validation or regex matching",
    "Never log PII such as phone numbers",
    "Use structured logging with extra parameter for consistency",
    "Include explicit type hints on all test fixtures and parameters"
  ],
  "qualityGates": [
    "uv run ruff format .",
    "uv run ruff check . --fix",
    "uv run ty check src",
    "uv run pytest"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Fix recurrence_parser.py validation and caching",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the recurrence parser to properly validate input and use bounded caching to prevent memory issues.",
      "acceptanceCriteria": [
        "Reject non-positive intervals (days <= 0) with ValueError in parse_recurrence_to_cron",
        "Example: 'every 0 days' raises ValueError",
        "Example: 'every -5 days' raises ValueError",
        "Negative case: 'every 0 days' should not create INTERVAL:0:...",
        "Normalize input by stripping whitespace before validation in parse_recurrence_to_cron",
        "Example: '  daily  ' works after stripping",
        "Normalize input in parse_recurrence_for_personal_chore to be consistent",
        "Replace @functools.cache with @functools.lru_cache(maxsize=256) on parse_recurrence_to_cron",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T17:35:18.240004+00:00",
      "completedAt": "2026-02-02T17:40:03.610935+00:00",
      "updatedAt": "2026-02-02T17:40:03.610712+00:00"
    },
    {
      "id": "US-002",
      "title": "Remove PII from webhook admin notifications",
      "status": "done",
      "dependsOn": [],
      "description": "As a security-conscious developer, I want admin notifications to not include phone numbers to protect user privacy.",
      "acceptanceCriteria": [
        "Remove phone number from user_context in admin notification (src/interface/webhook.py:448)",
        "Use message_id as context instead of phone number",
        "Example: admin notification shows 'message_id: xyz123' instead of '+1234567890'",
        "No phone numbers appear in any admin notification logs",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T17:40:05.696638+00:00",
      "completedAt": "2026-02-02T17:45:03.808052+00:00",
      "updatedAt": "2026-02-02T17:45:03.807895+00:00"
    },
    {
      "id": "US-003",
      "title": "Narrow exception catch in webhook admin notifications",
      "status": "in_progress",
      "dependsOn": [],
      "description": "As a developer, I want exception handling to be specific to avoid masking unexpected errors.",
      "acceptanceCriteria": [
        "Replace broad 'except Exception' with specific exceptions (RuntimeError, ConnectionError, OSError) in src/interface/webhook.py:462",
        "Example: KeyError still raises and is logged",
        "Negative case: unexpected exceptions are not silently caught",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T17:45:05.884837+00:00",
      "completedAt": null,
      "updatedAt": "2026-02-02T17:45:05.885047+00:00"
    },
    {
      "id": "US-004",
      "title": "Remove unreachable code in whatsapp_sender.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want to remove unreachable code to improve maintainability and avoid confusion.",
      "acceptanceCriteria": [
        "Remove unreachable logger.error and return at end of send_wa_message function (src/interface/whatsapp_sender.py:174-175)",
        "All code paths still properly handle success and failure cases",
        "Example: successful message send still returns SendMessageResult",
        "Example: failed send still handles retries appropriately",
        "All type hints pass ty check"
      ],
      "updatedAt": "2026-02-02T18:00:01.253785+00:00",
      "completedAt": "2026-02-02T18:00:01.253926+00:00",
      "startedAt": "2026-02-02T18:00:01.253928+00:00"
    },
    {
      "id": "US-005",
      "title": "Add bounded cache to format_phone_for_waha",
      "status": "in_progress",
      "dependsOn": [],
      "description": "As a developer, I want the phone formatter to use bounded caching to prevent unbounded memory growth.",
      "acceptanceCriteria": [
        "Replace @functools.cache with @functools.lru_cache(maxsize=1024) on format_phone_for_waha in src/interface/whatsapp_sender.py:72",
        "Cache still provides same functionality with bounded size",
        "Example: first 1024 unique phone numbers are cached, 1025th evicts oldest",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T18:00:03.362271+00:00",
      "completedAt": null,
      "updatedAt": "2026-02-02T18:00:03.362453+00:00"
    },
    {
      "id": "US-006",
      "title": "Document type: ignore rationale in config.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a maintainer, I want type: ignore directives to have explanatory comments to aid understanding.",
      "acceptanceCriteria": [
        "Add inline comment explaining why type: ignore[arg-type] is needed in src/core/config.py:169-171",
        "Comment explains Settings() may raise ValidationError for missing required fields",
        "All type hints pass ty check"
      ],
      "updatedAt": "2026-02-02T18:04:43.444642+00:00",
      "completedAt": "2026-02-02T18:04:43.444815+00:00",
      "startedAt": "2026-02-02T18:04:43.444817+00:00"
    },
    {
      "id": "US-007",
      "title": "Standardize logging in personal_verification_service.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want consistent structured logging throughout the codebase for better log aggregation.",
      "acceptanceCriteria": [
        "Convert f-string logs to structured logging with extra parameter in src/services/personal_verification_service.py:277, 295, 305",
        "Line 277: use extra={'log_id': log['id']}",
        "Line 295: use appropriate structured logging fields",
        "Line 305: use appropriate structured logging fields",
        "Example: logger.info('Auto-verified personal chore log (48h timeout)', extra={'log_id': log['id']})",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T18:04:45.563533+00:00",
      "completedAt": "2026-02-02T18:07:24.556977+00:00",
      "updatedAt": "2026-02-02T18:07:24.556818+00:00"
    },
    {
      "id": "US-008",
      "title": "Standardize logging in conflict_service.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want consistent structured logging throughout the codebase for better log aggregation.",
      "acceptanceCriteria": [
        "Convert f-string logs to structured logging with extra parameter in src/services/conflict_service.py:275, 281, 287",
        "Line 275: use extra={'chore_id': chore_id, 'result': 'approved'}",
        "Line 281: use extra={'chore_id': chore_id, 'result': 'rejected'}",
        "Line 287: use extra={'chore_id': chore_id, 'result': 'deadlock'}",
        "Example: logger.info('Vote result: APPROVED - chore completed', extra={'chore_id': chore_id, 'result': 'approved'})",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T18:07:26.666695+00:00",
      "completedAt": "2026-02-02T18:10:00.058659+00:00",
      "updatedAt": "2026-02-02T18:10:00.058493+00:00"
    },
    {
      "id": "US-009",
      "title": "Standardize logging in notification_service.py",
      "status": "in_progress",
      "dependsOn": [],
      "description": "As a developer, I want consistent structured logging throughout the codebase for better log aggregation.",
      "acceptanceCriteria": [
        "Convert f-string error logs to structured logging with extra parameter in src/services/notification_service.py:49, 57, 98",
        "All error logs use consistent structured logging format",
        "Example: logger.error('Failed to send notification', extra={'error_type': '...', 'recipient': '...'})",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T18:10:02.166616+00:00",
      "completedAt": null,
      "updatedAt": "2026-02-02T18:10:02.166873+00:00"
    },
    {
      "id": "US-010",
      "title": "Add type hints to test_whatsapp_sender.py fixture",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want all test fixtures and parameters to have explicit type hints to meet strict typing requirements.",
      "acceptanceCriteria": [
        "Add Generator import from collections.abc in tests/unit/test_whatsapp_sender.py",
        "Add return type annotation to mock_asyncio_sleep fixture: -> Generator[AsyncMock, None, None]",
        "Add type hint to mock_rate_limiter parameter in test_send_text_message_rate_limited: MagicMock",
        "Add type hint to mock_rate_limiter parameter in test_rate_limiter_records_request: MagicMock",
        "All tests pass with pytest",
        "All type hints pass ty check"
      ],
      "updatedAt": "2026-02-02T18:16:36.802866+00:00",
      "completedAt": "2026-02-02T18:16:36.803035+00:00",
      "startedAt": "2026-02-02T18:16:36.803037+00:00"
    },
    {
      "id": "US-011",
      "title": "Remove hard-coded rate limit in test_whatsapp_sender.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want tests to use constants instead of magic numbers to stay aligned if the limit changes.",
      "acceptanceCriteria": [
        "Import constants from src.interface in tests/unit/test_whatsapp_sender.py",
        "Replace hard-coded 60 with constants.MAX_REQUESTS_PER_MINUTE on line 47",
        "Replace hard-coded 60 with constants.MAX_REQUESTS_PER_MINUTE on line 60",
        "All tests pass with pytest",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T18:16:38.917140+00:00",
      "completedAt": "2026-02-02T18:18:48.793517+00:00",
      "updatedAt": "2026-02-02T18:18:48.793332+00:00"
    },
    {
      "id": "US-012",
      "title": "Remove duplicate assertion in test_config.py",
      "status": "in_progress",
      "dependsOn": [],
      "description": "As a developer, I want to remove duplicate test code to improve clarity and maintainability.",
      "acceptanceCriteria": [
        "Remove duplicate assertion on lines 19-21 in tests/unit/test_config.py",
        "Test still validates require_credential returns correct value",
        "All tests pass with pytest",
        "All type hints pass ty check"
      ],
      "startedAt": "2026-02-02T18:18:50.912746+00:00",
      "completedAt": null,
      "updatedAt": "2026-02-02T18:18:50.912950+00:00"
    },
    {
      "id": "US-013",
      "title": "Refactor test_webhook.py to reduce positional params",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want test signatures to use \u22642 parameters per keyword-only argument guidelines.",
      "acceptanceCriteria": [
        "Move patches into context managers or fixtures in tests/unit/test_webhook.py:21-145, 262-308, 342-345",
        "Test signatures use keyword-only arguments with * for functions with >2 parameters",
        "Example: def test_something(*, db_client: MagicMock, message: dict) -> None:",
        "All tests pass with pytest",
        "All type hints pass ty check"
      ]
    },
    {
      "id": "US-014",
      "title": "Replace DB mocks with ephemeral PocketBase in test_webhook.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want to test against real database logic instead of mocking to catch integration issues.",
      "acceptanceCriteria": [
        "Remove db_client mocks in tests/unit/test_webhook.py:221-333, 338-377",
        "Create ephemeral PocketBase instance for integration testing",
        "Tests exercise real DB interactions",
        "All tests pass with pytest",
        "All type hints pass ty check"
      ]
    },
    {
      "id": "US-015",
      "title": "Replace DB mocks with ephemeral PocketBase in test_webhook_rate_limiting.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want to test against real database logic instead of mocking to catch integration issues.",
      "acceptanceCriteria": [
        "Remove DB mocks in tests/unit/test_webhook_rate_limiting.py:99-189",
        "Create ephemeral PocketBase instance for integration testing",
        "Tests exercise real DB interactions",
        "All tests pass with pytest",
        "All type hints pass ty check"
      ]
    }
  ]
}
