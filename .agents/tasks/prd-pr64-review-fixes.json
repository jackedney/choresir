{
  "version": 1,
  "project": "PR #64 Review Fixes - Choresir",
  "overview": "Address all CodeRabbit review comments from PR #64 including critical security fixes, PII logging removal, structured logging improvements, type hint additions, formatting fixes, and code quality improvements.",
  "goals": [
    "Pass all CI/CD pipeline checks (ruff format, ruff check, ty, pytest)",
    "Remove all PII from log messages (phone numbers, chore titles)",
    "Implement X-Hub-Signature-256 webhook validation replacing X-Webhook-Hmac",
    "Add structured logging with standardized extra fields (operation, status, error, user_id, chore_id)",
    "Add return type hints (-> None) to all test functions",
    "Convert verbose docstrings to single-line format",
    "Fix all exception handling to include PermissionError where needed",
    "Remove duplicate code and stale mock references"
  ],
  "nonGoals": [
    "No new feature development",
    "No database schema changes",
    "No API endpoint changes",
    "No UI/frontend changes"
  ],
  "successMetrics": [
    "All ruff format checks pass",
    "All ruff check (lint) checks pass",
    "All ty (type checking) checks pass",
    "All pytest tests pass",
    "No PII appears in any log statements",
    "All test functions have -> None return type hints"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "FastAPI",
    "hosting": "Unknown",
    "database": "PocketBase",
    "auth": "WAHA webhook HMAC validation"
  },
  "routes": [],
  "uiNotes": [],
  "dataModel": [],
  "importFormat": {
    "description": "Not applicable",
    "example": {}
  },
  "rules": [
    "Never log PII (phone numbers, personal chore titles) - use IDs instead",
    "Use structured logging with extra parameter containing: operation, status, error, user_id, chore_id",
    "All functions must have explicit return type hints",
    "Docstrings must be single-line",
    "Exception handlers must be specific (no bare except Exception unless justified)"
  ],
  "qualityGates": [
    "ruff format --check .",
    "ruff check .",
    "ty",
    "pytest"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Replace X-Webhook-Hmac with X-Hub-Signature-256 validation",
      "status": "done",
      "dependsOn": [],
      "description": "As a security engineer, I want webhook validation to use X-Hub-Signature-256 (SHA256) instead of X-Webhook-Hmac (SHA512) so that we follow standard webhook security practices.",
      "acceptanceCriteria": [
        "Update validate_webhook_hmac in src/interface/webhook_security.py to use X-Hub-Signature-256 header",
        "Compute SHA256 HMAC of raw_body using secret",
        "Use hmac.compare_digest for timing-safe comparison",
        "Update all references from X-Webhook-Hmac to X-Hub-Signature-256",
        "Example: Valid X-Hub-Signature-256 header with correct HMAC -> returns is_valid=True",
        "Negative case: Missing X-Hub-Signature-256 header -> returns is_valid=False with 401 status",
        "Negative case: Invalid signature -> returns is_valid=False with 401 status",
        "Update related tests in tests/unit/test_webhook_security.py"
      ],
      "startedAt": "2026-02-02T12:14:10.633418+00:00",
      "completedAt": "2026-02-02T12:20:03.708491+00:00",
      "updatedAt": "2026-02-02T12:20:03.708347+00:00"
    },
    {
      "id": "US-002",
      "title": "Add structured logging to webhook_security.py warning logs",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want warning logs in webhook_security.py to use structured logging with extra parameter so that logs are consistent and searchable.",
      "acceptanceCriteria": [
        "Update logger.warning at line 121 (missing signature) to include extra={'operation': 'validate_webhook_hmac', 'status': 'missing_signature'}",
        "Update logger.warning at line 135 (invalid signature) to include extra={'operation': 'validate_webhook_hmac', 'status': 'invalid_signature'}",
        "Update logger.warning at line 36 (invalid timestamp format) to include extra={'operation': 'validate_webhook_timestamp', 'timestamp_str': timestamp_str}",
        "Example: Missing signature logs with operation and status fields in extra",
        "Negative case: Do not include secret or raw_body in extra fields"
      ],
      "startedAt": "2026-02-02T12:20:05.821840+00:00",
      "completedAt": "2026-02-02T12:24:15.176127+00:00",
      "updatedAt": "2026-02-02T12:24:15.175957+00:00"
    },
    {
      "id": "US-003",
      "title": "Remove PII from personal_verification_service.py logs",
      "status": "done",
      "dependsOn": [],
      "description": "As a security engineer, I want phone numbers and chore titles removed from log messages so that PII is not exposed in logs.",
      "acceptanceCriteria": [
        "Update logger.info at lines 61-63 to remove partner_phone, use chore_id instead with extra parameter",
        "Update logger.warning at lines 68-70 to remove partner_phone, use chore_id instead with extra parameter",
        "Update logger.info at lines 91-94 to replace chore_title with chore_id in extra parameter",
        "Example: Log 'Partner inactive for chore, auto-converting to self-verified' with extra={'chore_id': chore_id, 'reason': 'partner_inactive'}",
        "Negative case: No phone numbers appear anywhere in log messages"
      ],
      "startedAt": "2026-02-02T12:24:17.262647+00:00",
      "completedAt": "2026-02-02T12:27:40.852447+00:00",
      "updatedAt": "2026-02-02T12:27:40.852278+00:00"
    },
    {
      "id": "US-004",
      "title": "Add structured logging to rate_limiter.py exception handler",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the rate limiter exception handler to use structured logging so that debugging is easier.",
      "acceptanceCriteria": [
        "Update logger.exception at line 97 to include extra={'scope': scope, 'limit': limit, 'window_seconds': window_seconds}",
        "Keep exc_info preserved for stack trace",
        "Example: Rate limit error logs with scope, limit, and window_seconds in extra",
        "Negative case: Do not include user identifiers, phone numbers, or emails in extra"
      ],
      "startedAt": "2026-02-02T12:27:42.928740+00:00",
      "completedAt": "2026-02-02T12:31:53.439282+00:00",
      "updatedAt": "2026-02-02T12:31:53.439118+00:00"
    },
    {
      "id": "US-005",
      "title": "Add PermissionError to exception tuples in chore_tools.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want PermissionError caught in chore_tools.py exception handlers so that permission errors are handled gracefully.",
      "acceptanceCriteria": [
        "Update except tuple at lines 108-110 in tool_define_chore to include PermissionError",
        "Update except tuple at lines 244-246 in tool_log_chore to include PermissionError",
        "New tuple: except (RuntimeError, KeyError, ConnectionError, PermissionError)",
        "Log with logger.error including extra={'error': str(e)}",
        "Example: PermissionError raised by verification_service.request_verification() is caught and returns graceful error message",
        "Negative case: PermissionError does not propagate unhandled"
      ],
      "startedAt": "2026-02-02T12:31:55.546376+00:00",
      "completedAt": "2026-02-02T12:35:30.533235+00:00",
      "updatedAt": "2026-02-02T12:35:30.533086+00:00"
    },
    {
      "id": "US-006",
      "title": "Fix structured logging in chore_tools.py",
      "status": "done",
      "dependsOn": [
        "US-005"
      ],
      "description": "As a developer, I want consistent structured logging in chore_tools.py so that logs are searchable.",
      "acceptanceCriteria": [
        "Update logger.error at line 136 to use extra parameter instead of f-string",
        "Change from: logger.error(f'Failed to increment takeover count: {e}')",
        "Change to: logger.error('Failed to increment takeover count', extra={'error': str(e)})",
        "Example: Error logged with error field in extra parameter",
        "Negative case: No f-string interpolation in log messages for error context"
      ],
      "startedAt": "2026-02-02T12:35:32.636389+00:00",
      "completedAt": "2026-02-02T12:38:04.681587+00:00",
      "updatedAt": "2026-02-02T12:38:04.681432+00:00"
    },
    {
      "id": "US-007",
      "title": "Add return type hints to test_webhook_security.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want all test methods in test_webhook_security.py to have -> None return type hints for code quality.",
      "acceptanceCriteria": [
        "Add -> None to test_valid_hmac_signature method",
        "Add -> None to test_missing_hmac_header method",
        "Add -> None to test_invalid_hmac_signature method",
        "Example: def test_valid_hmac_signature(self) -> None:",
        "Negative case: No test method without return type hint"
      ],
      "startedAt": "2026-02-02T12:38:06.794444+00:00",
      "completedAt": "2026-02-02T12:43:10.803524+00:00",
      "updatedAt": "2026-02-02T12:43:10.803368+00:00"
    },
    {
      "id": "US-008",
      "title": "Add return type hints to test_whatsapp_parser.py",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want all test functions in test_whatsapp_parser.py to have -> None return type hints for code quality.",
      "acceptanceCriteria": [
        "Add -> None to test_parse_simple_text_message",
        "Add -> None to test_parse_direct_payload",
        "Add -> None to test_parse_ignore_status_broadcast",
        "Add -> None to test_parse_button_response_selected_id_root",
        "Add -> None to test_parse_button_response_selected_id_data",
        "Add -> None to test_parse_list_response",
        "Add -> None to test_parse_invalid_data",
        "Add -> None to test_parse_missing_timestamp",
        "Add -> None to test_parse_empty_timestamp",
        "Add -> None to test_parse_valid_timestamp",
        "Example: def test_parse_simple_text_message() -> None:",
        "Negative case: No test function without return type hint"
      ],
      "startedAt": "2026-02-02T12:43:12.911333+00:00",
      "completedAt": "2026-02-02T12:43:12.911333+00:00",
      "updatedAt": "2026-02-02T12:43:12.911534+00:00"
    },
    {
      "id": "US-009",
      "title": "Add return type hints to test_whatsapp_sender.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want all test methods in test_whatsapp_sender.py to have -> None return type hints for code quality.",
      "acceptanceCriteria": [
        "Add -> None to TestRateLimiter methods: test_can_send_when_under_limit, test_cannot_send_when_at_limit, test_rate_limit_per_phone",
        "Add -> None to TestSendTextMessage async methods: test_send_text_message_success, test_send_text_message_client_error, test_send_text_message_server_error_with_retry, test_send_text_message_rate_limited, test_rate_limiter_records_request, test_send_text_message_unexpected_error",
        "Example: async def test_send_text_message_success(self) -> None:",
        "Negative case: No test method without return type hint"
      ]
    },
    {
      "id": "US-010",
      "title": "Add return type hints to test_config.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want all test functions in test_config.py to have -> None return type hints for code quality.",
      "acceptanceCriteria": [
        "Add -> None to test_require_credential_with_valid_value",
        "Add -> None to test_require_credential_with_none_raises_error",
        "Add -> None to test_require_credential_with_empty_string_raises_error",
        "Add -> None to test_require_credential_error_message_includes_field_name",
        "Add -> None to test_require_waha_webhook_hmac_key",
        "Add -> None to test_require_waha_webhook_hmac_key_missing",
        "Add -> None to test_require_waha_webhook_hmac_key_empty",
        "Example: def test_require_credential_with_valid_value() -> None:",
        "Negative case: No test function without return type hint"
      ]
    },
    {
      "id": "US-011",
      "title": "Add return type hints to test_webhook.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want all test methods in test_webhook.py to have -> None return type hints for code quality.",
      "acceptanceCriteria": [
        "Add -> None to all test methods in TestReceiveWebhook class",
        "Add -> None to all test methods in TestProcessWebhookMessage class",
        "Add type hints to mock parameters (e.g., mock_parse: MagicMock)",
        "Example: async def test_receive_webhook_valid(self, mock_parse: MagicMock, mock_process: MagicMock) -> None:",
        "Negative case: No test method without return type hint"
      ]
    },
    {
      "id": "US-012",
      "title": "Add return type hints to test_webhook_rate_limiting.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want all test functions in test_webhook_rate_limiting.py to have -> None return type hints for code quality.",
      "acceptanceCriteria": [
        "Add -> None to all test functions in the file",
        "Example: async def test_rate_limiting_valid_request() -> None:",
        "Negative case: No test function without return type hint"
      ]
    },
    {
      "id": "US-013",
      "title": "Mock rate_limiter in test_webhook.py",
      "status": "open",
      "dependsOn": [
        "US-011"
      ],
      "description": "As a developer, I want rate_limiter.check_webhook_rate_limit mocked in webhook tests so that tests don't depend on rate limiter initialization.",
      "acceptanceCriteria": [
        "Add patch for src.interface.webhook.rate_limiter.check_webhook_rate_limit in test_receive_webhook_valid_hmac_proceeds",
        "Mock should return AsyncMock(return_value=None)",
        "Example: @patch('src.interface.webhook.rate_limiter.check_webhook_rate_limit', new_callable=AsyncMock, return_value=None)",
        "Negative case: Test does not call real rate limiter"
      ]
    },
    {
      "id": "US-014",
      "title": "Remove stale Twilio mock code from test_webhook_rate_limiting.py",
      "status": "open",
      "dependsOn": [
        "US-012"
      ],
      "description": "As a developer, I want stale Twilio mock code removed from webhook rate limiting tests so that tests are clean.",
      "acceptanceCriteria": [
        "Remove patch for src.interface.webhook.webhook_security at line 79",
        "Remove mock_security_result configuration at lines 90-92 (verify_webhook_security doesn't exist in WAHA)",
        "Keep only the validate_webhook_hmac mock which is the correct WAHA implementation",
        "Example: Test uses only validate_webhook_hmac mock",
        "Negative case: No references to verify_webhook_security"
      ]
    },
    {
      "id": "US-015",
      "title": "Run ruff format on whatsapp_sender.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want whatsapp_sender.py formatted with ruff so that CI formatting checks pass.",
      "acceptanceCriteria": [
        "Run ruff format src/interface/whatsapp_sender.py",
        "Fix indentation around exception handlers at lines 138-146",
        "Align except blocks consistently",
        "Example: ruff format --check src/interface/whatsapp_sender.py passes",
        "Negative case: No formatting violations"
      ]
    },
    {
      "id": "US-016",
      "title": "Run ruff format on test_notification_service.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want test_notification_service.py formatted with ruff so that CI formatting checks pass.",
      "acceptanceCriteria": [
        "Run ruff format tests/unit/test_notification_service.py",
        "Fix formatting around lines 53-60",
        "Example: ruff format --check tests/unit/test_notification_service.py passes",
        "Negative case: No formatting violations"
      ]
    },
    {
      "id": "US-017",
      "title": "Run ruff format on test_webhook.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want test_webhook.py formatted with ruff so that CI formatting checks pass.",
      "acceptanceCriteria": [
        "Run ruff format tests/unit/test_webhook.py",
        "Example: ruff format --check tests/unit/test_webhook.py passes",
        "Negative case: No formatting violations"
      ]
    },
    {
      "id": "US-018",
      "title": "Run ruff format on test_webhook_rate_limiting.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want test_webhook_rate_limiting.py formatted with ruff so that CI formatting checks pass.",
      "acceptanceCriteria": [
        "Run ruff format tests/unit/test_webhook_rate_limiting.py",
        "Example: ruff format --check tests/unit/test_webhook_rate_limiting.py passes",
        "Negative case: No formatting violations"
      ]
    },
    {
      "id": "US-019",
      "title": "Run ruff format on whatsapp_parser.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want whatsapp_parser.py formatted with ruff so that CI formatting checks pass.",
      "acceptanceCriteria": [
        "Run ruff format src/interface/whatsapp_parser.py",
        "Fix extra indentation at lines 87 and 93",
        "Example: ruff format --check src/interface/whatsapp_parser.py passes",
        "Negative case: No formatting violations"
      ]
    },
    {
      "id": "US-020",
      "title": "Add module-level logger to whatsapp_sender.py",
      "status": "open",
      "dependsOn": [
        "US-015"
      ],
      "description": "As a developer, I want whatsapp_sender.py to have a module-level logger with structured logging for send failures.",
      "acceptanceCriteria": [
        "Add import logging at top of file",
        "Add logger = logging.getLogger(__name__) after imports",
        "Add logger.error before 'Max retries exceeded' return with extra={'max_retries': max_retries}",
        "Example: logger.error('WAHA send failed after retries', extra={'max_retries': max_retries})",
        "Negative case: No phone numbers or message text in log messages"
      ]
    },
    {
      "id": "US-021",
      "title": "Remove duplicate logger declaration in choresir_agent.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want duplicate logger declarations removed from choresir_agent.py so that code is clean.",
      "acceptanceCriteria": [
        "Remove duplicate logger = logging.getLogger(__name__) at line 24",
        "Keep only the declaration at line 21",
        "Example: Single logger declaration in file",
        "Negative case: No duplicate logger declarations"
      ]
    },
    {
      "id": "US-022",
      "title": "Audit all files for duplicate logger declarations",
      "status": "open",
      "dependsOn": [
        "US-021"
      ],
      "description": "As a developer, I want all files checked for duplicate logger declarations so that code is consistent.",
      "acceptanceCriteria": [
        "Search all Python files for multiple logger = logging.getLogger occurrences",
        "Remove any duplicates found",
        "Example: Each file has at most one logger declaration",
        "Negative case: No file has duplicate logger declarations"
      ]
    },
    {
      "id": "US-023",
      "title": "Make waha_webhook_hmac_key required in Pydantic config",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want waha_webhook_hmac_key to be a required field in Pydantic config so that missing configuration fails fast.",
      "acceptanceCriteria": [
        "Change waha_webhook_hmac_key from str | None = Field(default=None, ...) to str = Field(...)",
        "Remove the | None type annotation",
        "Remove default=None",
        "Example: waha_webhook_hmac_key: str = Field(description='WAHA Webhook HMAC key for payload validation')",
        "Negative case: Configuration initialization fails if field is not set"
      ]
    },
    {
      "id": "US-024",
      "title": "Convert docstrings to single-line in recurrence_parser.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want verbose docstrings in recurrence_parser.py converted to single-line format per style guide.",
      "acceptanceCriteria": [
        "Convert parse_recurrence_to_cron docstring (lines 12-26) to single line",
        "Convert parse_recurrence_for_personal_chore docstring (lines 44-63) to single line",
        "Example: \"\"\"Parse recurrence string to CRON expression or INTERVAL:N:cron format.\"\"\"",
        "Negative case: No multi-line docstrings in these functions"
      ]
    },
    {
      "id": "US-025",
      "title": "Fix structured logging in robin_hood_service.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want robin_hood_service.py to use structured logging with extra parameter consistently.",
      "acceptanceCriteria": [
        "Update logger.exception at lines 65-66 to use extra={'user_id': user_id}",
        "Update logger.info at line 103 to use extra={'user_id': user_id, 'new_count': new_count}",
        "Update logger.info at line 114 to use extra={'user_id': user_id}",
        "Update logger.error at lines 117-120 to use extra={'user_id': user_id, 'error': str(e)}",
        "Example: logger.info('Incremented takeover count', extra={'user_id': user_id, 'new_count': new_count})",
        "Negative case: No f-string interpolation for context fields in log messages"
      ]
    },
    {
      "id": "US-026",
      "title": "Use structured logging in errors.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want _match_error_pattern in errors.py to use keyword-only arguments and single-line docstring.",
      "acceptanceCriteria": [
        "Add * before first parameter to make all arguments keyword-only",
        "Convert docstring to single line: 'Return True if the error matches the configured pattern type.'",
        "Example: def _match_error_pattern(*, error_str: str, exception_type: str, pattern_type: ...) -> bool:",
        "Negative case: No positional arguments allowed"
      ]
    },
    {
      "id": "US-027",
      "title": "Format long lists in errors.py for readability",
      "status": "open",
      "dependsOn": [
        "US-026"
      ],
      "description": "As a developer, I want long phrase lists in errors.py formatted across multiple lines for readability.",
      "acceptanceCriteria": [
        "Split _ERROR_PATTERNS phrases lists across multiple lines (lines 70-89)",
        "Each phrase on its own line with trailing comma",
        "Keep within 120 character line limit",
        "Example: 'phrases': [\\n    'quota exceeded',\\n    'insufficient credits',\\n    ...]",
        "Negative case: No line exceeds 120 characters"
      ]
    },
    {
      "id": "US-028",
      "title": "Remove PII from webhook.py button payload logs",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want button payload logs in webhook.py to not expose sensitive data.",
      "acceptanceCriteria": [
        "Update logger.error at line 238 to use structured logging with truncated payload",
        "Update logger.error at line 249 similarly",
        "Example: logger.error('Invalid button payload format', extra={'payload_prefix': payload[:20] if payload else None})",
        "Negative case: Full payload not logged"
      ]
    },
    {
      "id": "US-029",
      "title": "Refactor redundant parsing in webhook.py _handle_webhook_error",
      "status": "open",
      "dependsOn": [
        "US-028"
      ],
      "description": "As a developer, I want _handle_webhook_error to parse webhook payload only once for efficiency.",
      "acceptanceCriteria": [
        "Parse parse_waha_webhook(params) once at start of function",
        "Reuse parsed_message variable instead of calling parse again at lines 435 and 456",
        "Example: parsed_message = whatsapp_parser.parse_waha_webhook(params) called once",
        "Negative case: parse_waha_webhook not called more than once per invocation"
      ]
    },
    {
      "id": "US-030",
      "title": "Use structured logging in pantry_service.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want pantry_service.py to use structured logging with extra parameter for user_id.",
      "acceptanceCriteria": [
        "Update logger.info at line 74 to move user_id to extra parameter",
        "Example: logger.info(f'Added to shopping list: {item_name}', extra={'user_id': user_id})",
        "Negative case: user_id not in message string"
      ]
    },
    {
      "id": "US-031",
      "title": "Use structured logging in chore_service.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want chore_service.py to use structured logging and avoid logging user-provided chore titles.",
      "acceptanceCriteria": [
        "Update logger.info at line 57 to use chore_id instead of title",
        "Use extra parameter for chore_id and assigned_to",
        "Example: logger.info('Created chore', extra={'chore_id': record['id'], 'assigned_to': assigned_to or 'unassigned'})",
        "Negative case: Chore title not in log message"
      ]
    },
    {
      "id": "US-032",
      "title": "Use structured logging in conflict_service.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want conflict_service.py to use structured logging consistently.",
      "acceptanceCriteria": [
        "Update logger.info at line 186 to use extra parameter",
        "Update logger.info at line 203 to use extra parameter",
        "Example: logger.info('User voted on chore', extra={'user_id': voter_user_id, 'choice': str(choice), 'chore_id': chore_id})",
        "Negative case: No f-string interpolation for context fields"
      ]
    },
    {
      "id": "US-033",
      "title": "Narrow exception handlers in analytics_service.py",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want broad exception handlers in analytics_service.py narrowed to specific expected exceptions.",
      "acceptanceCriteria": [
        "Review except Exception handlers at lines 593-596 and 606-609",
        "Replace with specific exceptions: (ValueError, KeyError, TypeError, ValidationError)",
        "Review if ConnectionError is actually expected at lines 616-619",
        "Example: except (ValueError, KeyError, TypeError, ValidationError) as e:",
        "Negative case: No bare except Exception unless justified"
      ]
    },
    {
      "id": "US-034",
      "title": "Remove KeyError from notification_service.py exception handlers",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want unnecessary KeyError removed from notification_service.py exception tuples.",
      "acceptanceCriteria": [
        "Remove KeyError from except tuple at lines 199-200",
        "Remove KeyError from except tuple at lines 253-254",
        "Example: except (RuntimeError, ConnectionError):",
        "Negative case: KeyError not in exception tuples for send_text_message calls"
      ]
    },
    {
      "id": "US-035",
      "title": "Add logging for retry attempts in whatsapp_sender.py",
      "status": "open",
      "dependsOn": [
        "US-020"
      ],
      "description": "As a developer, I want retry attempts logged in whatsapp_sender.py for debugging.",
      "acceptanceCriteria": [
        "Add logger.debug for HTTPStatusError retry with extra={'attempt': attempt + 1, 'status_code': e.response.status_code}",
        "Add logger.debug for network error retry with extra={'attempt': attempt + 1, 'error_type': type(e).__name__}",
        "Example: logger.debug('Server error, retrying', extra={'attempt': 2, 'status_code': 503})",
        "Negative case: No sensitive data in retry logs"
      ]
    },
    {
      "id": "US-036",
      "title": "Simplify webhook.py docstring",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want the receive_webhook docstring in webhook.py simplified to single line per style guide.",
      "acceptanceCriteria": [
        "Convert verbose docstring at lines 32-49 to single line",
        "Example: \"\"\"Receive and validate WAHA webhook POST requests.\"\"\"",
        "Negative case: No multi-line docstring for receive_webhook"
      ]
    },
    {
      "id": "US-037",
      "title": "Add Final annotations to Constants class",
      "status": "open",
      "dependsOn": [],
      "description": "As a developer, I want Constants class attributes in config.py marked as Final to prevent accidental modification.",
      "acceptanceCriteria": [
        "Add from typing import Final import",
        "Add Final annotation to all constants in Constants class (lines 88-165)",
        "Example: API_TIMEOUT_SECONDS: Final[int] = 30",
        "Negative case: Constants can still be accessed normally but mypy will warn on modification"
      ]
    }
  ]
}
