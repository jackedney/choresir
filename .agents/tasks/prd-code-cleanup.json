{
  "version": 1,
  "project": "Code Cleanup and Modernization",
  "overview": "Eliminate dead code, replace manual implementations with Python stdlib functions, fix code smells, and modernize the codebase to reduce maintenance burden and improve performance.",
  "goals": [
    "Remove all dead code including unused functions, imports, variables, and dependencies",
    "Replace manual implementations with stdlib equivalents (functools, itertools, collections, pathlib)",
    "Consolidate duplicated code patterns into reusable utilities",
    "Modernize code with Python 3.12 features where beneficial",
    "Standardize error handling and logging patterns"
  ],
  "nonGoals": [
    "Adding new features or functionality",
    "Changing external APIs or interfaces",
    "Refactoring architecture or module boundaries",
    "Upgrading dependencies"
  ],
  "successMetrics": [
    "All quality gates pass (ruff check, ruff format, pytest)",
    "Reduced lines of code through deduplication",
    "No unused imports or variables flagged by ruff",
    "Consistent use of stdlib utilities across codebase"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "FastAPI",
    "runtime": "Python 3.12",
    "database": "PocketBase",
    "tooling": "ruff, pytest, uv"
  },
  "routes": [],
  "uiNotes": [],
  "dataModel": [],
  "importFormat": {
    "description": "Not applicable",
    "example": {}
  },
  "rules": [
    "Use Pydantic models instead of dataclasses",
    "Preserve all existing functionality and external interfaces",
    "Each change must pass all tests before proceeding"
  ],
  "qualityGates": [
    "uv run ruff check --fix src tests && uv run ruff format src tests && uv run pytest"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Fix defaultdict bug and remove unused imports in core modules",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want to fix the defaultdict() bug in admin_notifier.py and remove any unused imports across core modules so that the code is correct and clean.",
      "acceptanceCriteria": [
        "Fix admin_notifier.py:28 - defaultdict() without factory should be plain dict[str, datetime] or defaultdict with proper factory",
        "Run ruff check to identify and remove all unused imports in src/core/",
        "Example: `from collections import defaultdict` removed if defaultdict is replaced with dict",
        "Negative case: Do not remove imports that are used indirectly (re-exports, type hints)",
        "All tests pass after changes"
      ],
      "startedAt": "2026-02-01T22:28:05.194734+00:00",
      "completedAt": "2026-02-01T22:30:33.149779+00:00",
      "updatedAt": "2026-02-01T22:30:33.149571+00:00"
    },
    {
      "id": "US-002",
      "title": "Consolidate error classification duplication in errors.py",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want to eliminate the ~70 lines of duplicated error phrase matching between classify_agent_error() and classify_error_with_response() so that error classification logic is maintainable.",
      "acceptanceCriteria": [
        "Extract shared ERROR_PATTERNS dict with categories: quota, rate_limit, auth, network, validation, context_length",
        "Create single internal _match_error_pattern() function used by both public functions",
        "Reduce total lines in errors.py by at least 50 lines",
        "Example: Adding a new error pattern only requires updating ERROR_PATTERNS dict",
        "Negative case: Ensure both functions still return their different result types correctly",
        "All existing tests for error classification pass"
      ],
      "startedAt": "2026-02-01T22:30:35.250383+00:00",
      "completedAt": "2026-02-01T22:38:44.083124+00:00",
      "updatedAt": "2026-02-01T22:38:44.082862+00:00"
    },
    {
      "id": "US-003",
      "title": "Replace manual grouping with itertools.groupby in scheduler.py",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want to use itertools.groupby instead of manual dict-building loops so that grouping logic is more Pythonic and maintainable.",
      "acceptanceCriteria": [
        "Replace manual chores_by_user grouping (scheduler.py:94-102) with itertools.groupby and operator.attrgetter",
        "Identify and replace any other manual grouping patterns in src/",
        "Example: `chores_by_user = {k: list(v) for k, v in groupby(sorted(chores, key=attrgetter('assigned_to')), key=attrgetter('assigned_to'))}`",
        "Negative case: Ensure sorted() is called before groupby when input is not pre-sorted",
        "All scheduler tests pass"
      ],
      "startedAt": "2026-02-01T22:38:46.204792+00:00",
      "completedAt": "2026-02-02T09:22:41.750270+00:00",
      "updatedAt": "2026-02-02T09:22:41.749862+00:00"
    },
    {
      "id": "US-004",
      "title": "Introduce functools.cache and functools.partial where beneficial",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want to use functools caching and partial application to simplify repetitive code patterns.",
      "acceptanceCriteria": [
        "Identify pure functions that could benefit from @functools.cache or @functools.lru_cache",
        "Replace lambda wrappers with functools.partial where applicable",
        "Example: Caching emoji lookups in _get_rank_emoji() if called repeatedly",
        "Negative case: Do not cache functions with side effects or mutable arguments",
        "All tests pass after changes"
      ],
      "updatedAt": "2026-02-01T22:49:44.779512+00:00",
      "completedAt": "2026-02-01T22:49:44.779658+00:00",
      "startedAt": "2026-02-01T22:49:44.779660+00:00"
    },
    {
      "id": "US-005",
      "title": "Standardize logging to use logger.exception() in error handlers",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want consistent logging patterns so that error tracking is reliable and debuggable.",
      "acceptanceCriteria": [
        "Replace logger.error(..., exc_info=True) with logger.exception() in except blocks",
        "Replace logger.error(f'...{e}') with logger.exception() when catching exceptions",
        "Standardize on f-strings for all log messages (remove % formatting and .format())",
        "Example: `except Exception as e: logger.exception('Failed to send reminder')` instead of `logger.error(f'Error: {e}')`",
        "Negative case: Keep logger.error() when not in an exception context",
        "All tests pass"
      ],
      "startedAt": "2026-02-01T22:49:46.875340+00:00",
      "completedAt": "2026-02-02T09:39:38.118304+00:00",
      "updatedAt": "2026-02-02T09:39:38.118156+00:00"
    },
    {
      "id": "US-006",
      "title": "Extract database update pattern to reusable utility",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a developer, I want a reusable pattern for get-then-update database operations so that this 65+ occurrence pattern is DRY.",
      "acceptanceCriteria": [
        "Create db_client utility method: update_first_matching(collection, filter_query, update_data) -> bool",
        "Replace repeated get_first_record + update_record patterns with the new utility",
        "Start with webhook.py which has multiple instances of this pattern",
        "Example: `await db_client.update_first_matching('messages', f'waha_id=\"{msg_id}\"', {'status': 'delivered'})`",
        "Negative case: Keep separate calls when additional logic exists between get and update",
        "All tests pass"
      ],
      "updatedAt": "2026-02-01T23:00:01.257833+00:00",
      "completedAt": "2026-02-01T23:00:01.257974+00:00",
      "startedAt": "2026-02-01T23:00:01.257976+00:00"
    },
    {
      "id": "US-007",
      "title": "Replace magic numbers and strings with constants",
      "status": "in_progress",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want magic values extracted to named constants so that code is self-documenting and changes are centralized.",
      "acceptanceCriteria": [
        "Extract magic numbers: chunk_size=50 (analytics), max_connections=10 (redis), maxlen=100 (tracker)",
        "Add constants to appropriate config or constants module",
        "Example: `ANALYTICS_CHUNK_SIZE = 50` in config, used as `chunk_size=config.ANALYTICS_CHUNK_SIZE`",
        "Negative case: Keep inline values for truly one-off or self-explanatory cases (e.g., `range(3)` for retries already named)",
        "All tests pass"
      ],
      "startedAt": "2026-02-01T23:00:03.339038+00:00",
      "completedAt": null,
      "updatedAt": "2026-02-02T09:39:40.230241+00:00"
    },
    {
      "id": "US-008",
      "title": "Use match statements for complex conditional chains",
      "status": "open",
      "dependsOn": [
        "US-003"
      ],
      "description": "As a developer, I want to use Python 3.10+ match statements to replace complex if-elif chains for better readability.",
      "acceptanceCriteria": [
        "Convert _get_dynamic_title() (scheduler.py:207-215) to use match statement",
        "Identify other if-elif chains with 4+ branches that could benefit from match",
        "Example: `match (rank, completions): case (1, c) if c >= THRESHOLD: return 'Carrying the team!'`",
        "Negative case: Keep simple if-else for 2-3 conditions where match adds verbosity",
        "All tests pass"
      ]
    },
    {
      "id": "US-009",
      "title": "Modernize TypeVar usage with Python 3.12 type syntax",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a developer, I want to use Python 3.12 type parameter syntax for cleaner generic type definitions.",
      "acceptanceCriteria": [
        "Replace `T = TypeVar('T')` with `type T = TypeVar('T')` or inline type parameters where supported",
        "Update redis_client.py and db_client.py TypeVar definitions",
        "Example: Function signatures using `def func[T](arg: T) -> T:` syntax where applicable",
        "Negative case: Keep traditional TypeVar for complex bounds or constraints not yet supported",
        "All tests pass and type checker (if used) passes"
      ],
      "updatedAt": "2026-02-01T23:10:17.308920+00:00",
      "completedAt": "2026-02-01T23:10:17.309066+00:00",
      "startedAt": "2026-02-01T23:10:17.309068+00:00"
    },
    {
      "id": "US-010",
      "title": "Narrow broad exception handlers to specific types",
      "status": "open",
      "dependsOn": [
        "US-005"
      ],
      "description": "As a developer, I want specific exception types caught instead of broad Exception so that errors are properly categorized and debuggable.",
      "acceptanceCriteria": [
        "Audit all 21 `except Exception` handlers",
        "Replace with specific exceptions where the error type is known (e.g., httpx.HTTPError, pydantic.ValidationError)",
        "Keep broad Exception only at top-level error boundaries with proper logging",
        "Example: `except httpx.TimeoutException: ...` instead of `except Exception:`",
        "Negative case: Top-level FastAPI exception handlers may legitimately catch Exception",
        "All tests pass"
      ]
    },
    {
      "id": "US-011",
      "title": "Remove unused dependencies from pyproject.toml",
      "status": "open",
      "dependsOn": [
        "US-010"
      ],
      "description": "As a developer, I want only necessary dependencies in pyproject.toml so that the project has minimal attack surface and faster installs.",
      "acceptanceCriteria": [
        "Audit all dependencies in pyproject.toml against actual imports in src/",
        "Remove any dependencies not imported anywhere",
        "Verify optional dev dependencies are all used in tests/ or tooling",
        "Example: If `croniter` is imported, keep it; if not, remove it",
        "Negative case: Keep transitive dependencies that are required by direct deps",
        "All tests pass with the reduced dependency set"
      ]
    },
    {
      "id": "US-012",
      "title": "Final cleanup pass with ruff and remove commented code",
      "status": "open",
      "dependsOn": [
        "US-011"
      ],
      "description": "As a developer, I want a final automated cleanup pass to catch any remaining issues and remove all commented-out code blocks.",
      "acceptanceCriteria": [
        "Run `uv run ruff check --fix src tests` to auto-fix remaining issues",
        "Run `uv run ruff format src tests` to ensure consistent formatting",
        "Manually review and remove any commented-out code blocks (ERA rule)",
        "Example: Remove `# old_function()` or `# TODO: delete this` dead code",
        "Negative case: Keep legitimate TODO comments that reference future work with issue numbers",
        "All quality gates pass: ruff check, ruff format, pytest"
      ]
    }
  ]
}
