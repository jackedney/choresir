{
  "version": 1,
  "project": "PR #64 WAHA Integration Fixes",
  "overview": "Address security vulnerabilities, error handling gaps, and code quality issues identified in PR #64 (WAHA WhatsApp integration). Critical security fix adds HMAC webhook validation, followed by logging improvements and code cleanup.",
  "goals": [
    "Prevent forged webhook payloads via HMAC signature validation",
    "Handle missing timestamp in webhook parser gracefully",
    "Add structured logging to sender module for debugging",
    "Remove PII (phone numbers) from all log messages across codebase",
    "Add type hints to test methods",
    "Eliminate redundant webhook parsing"
  ],
  "nonGoals": [
    "Changing the WAHA API integration approach",
    "Adding new WhatsApp features",
    "Refactoring the entire webhook flow"
  ],
  "successMetrics": [
    "All quality gates pass (pytest, ruff check, ruff format, ty check)",
    "HMAC validation blocks requests without valid signature",
    "Application fails to start without WAHA_WEBHOOK_HMAC_KEY configured",
    "No phone numbers appear in log output"
  ],
  "openQuestions": [],
  "stack": {
    "framework": "FastAPI",
    "hosting": "Docker/self-hosted",
    "database": "PocketBase",
    "auth": "WAHA webhook HMAC (SHA512)"
  },
  "routes": [],
  "uiNotes": [],
  "dataModel": [],
  "importFormat": {
    "description": "Not applicable",
    "example": {}
  },
  "rules": [
    "HMAC validation is mandatory - startup fails without WAHA_WEBHOOK_HMAC_KEY",
    "Invalid HMAC returns 401 Unauthorized and logs the attempt",
    "Missing timestamp in webhook payload raises explicit error (rejects webhook)",
    "Phone numbers must never appear in log messages - use structured metadata instead"
  ],
  "qualityGates": [
    "pytest",
    "ruff check",
    "ruff format --check",
    "ty check"
  ],
  "stories": [
    {
      "id": "US-001",
      "title": "Add WAHA_WEBHOOK_HMAC_KEY setting",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want a mandatory WAHA_WEBHOOK_HMAC_KEY configuration setting so that webhook HMAC validation can be performed.",
      "acceptanceCriteria": [
        "Add `waha_webhook_hmac_key: str` field to Settings class in src/core/config.py (no default value)",
        "Application raises startup error if WAHA_WEBHOOK_HMAC_KEY is not set",
        "Add startup validation in main.py or lifespan that calls settings.require_credential('waha_webhook_hmac_key', 'WAHA Webhook HMAC')",
        "Example: Setting WAHA_WEBHOOK_HMAC_KEY=secret123 allows startup",
        "Negative case: Missing WAHA_WEBHOOK_HMAC_KEY raises ValueError with clear message",
        "Update existing tests that mock settings to include this field"
      ],
      "startedAt": "2026-02-01T21:13:12.980741+00:00",
      "completedAt": "2026-02-01T21:21:50.706260+00:00",
      "updatedAt": "2026-02-01T21:21:50.705814+00:00"
    },
    {
      "id": "US-002",
      "title": "Implement HMAC webhook validation",
      "status": "done",
      "dependsOn": [
        "US-001"
      ],
      "description": "As a system administrator, I want incoming webhooks validated via HMAC signature so that forged payloads are rejected.",
      "acceptanceCriteria": [
        "Add `validate_webhook_hmac(raw_body: bytes, signature: str, secret: str) -> WebhookSecurityResult` function to src/interface/webhook_security.py",
        "Compute expected signature as SHA512 HMAC of raw request body using secret key",
        "Compare computed signature with X-Webhook-Hmac header value (constant-time comparison)",
        "Return WebhookSecurityResult(is_valid=False, error_message='Invalid webhook signature', http_status_code=401) on mismatch",
        "Return WebhookSecurityResult(is_valid=True, ...) on match",
        "Example: Valid HMAC header passes validation",
        "Negative case: Missing X-Webhook-Hmac header returns 401",
        "Negative case: Invalid HMAC signature returns 401 and logs warning",
        "Add unit tests in tests/unit/test_webhook_security.py for all cases"
      ],
      "startedAt": "2026-02-01T21:21:52.810046+00:00",
      "completedAt": "2026-02-01T21:26:28.263875+00:00",
      "updatedAt": "2026-02-01T21:26:28.263686+00:00"
    },
    {
      "id": "US-003",
      "title": "Integrate HMAC validation into webhook endpoint",
      "status": "done",
      "dependsOn": [
        "US-002"
      ],
      "description": "As a system administrator, I want the webhook endpoint to validate HMAC before processing so that unauthorized requests are blocked.",
      "acceptanceCriteria": [
        "Modify receive_webhook() in src/interface/webhook.py to read raw request body before JSON parsing",
        "Extract X-Webhook-Hmac header from request",
        "Call validate_webhook_hmac() before any other processing",
        "Return 401 Unauthorized with appropriate message if HMAC validation fails",
        "Log warning with extra={'operation': 'hmac_validation_failed'} (no PII)",
        "Example: Request with valid HMAC proceeds to normal processing",
        "Negative case: Request without header returns 401",
        "Negative case: Request with invalid signature returns 401",
        "Update tests/unit/test_webhook.py with HMAC validation tests"
      ],
      "startedAt": "2026-02-01T21:26:30.332810+00:00",
      "completedAt": "2026-02-01T21:37:55.672144+00:00",
      "updatedAt": "2026-02-01T21:37:55.671788+00:00"
    },
    {
      "id": "US-004",
      "title": "Handle missing timestamp in parser",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the webhook parser to raise an explicit error when timestamp is missing so that invalid webhooks are rejected clearly.",
      "acceptanceCriteria": [
        "Modify parse_waha_webhook() in src/interface/whatsapp_parser.py to check if timestamp is missing or empty",
        "If payload.get('timestamp') is None or empty string, raise ValueError('Missing required timestamp in webhook payload')",
        "This causes webhook to be rejected with 400 Bad Request (caught by exception handler)",
        "Example: Payload with timestamp=1678900000 parses successfully",
        "Negative case: Payload with no timestamp field raises ValueError",
        "Negative case: Payload with timestamp='' raises ValueError",
        "Update tests/unit/test_whatsapp_parser.py with test cases for missing timestamp"
      ],
      "startedAt": "2026-02-01T21:37:57.775001+00:00",
      "completedAt": "2026-02-01T21:45:02.090934+00:00",
      "updatedAt": "2026-02-01T21:45:02.090787+00:00"
    },
    {
      "id": "US-005",
      "title": "Add logging to sender module",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want the WhatsApp sender module to log send operations so that I can debug message delivery issues.",
      "acceptanceCriteria": [
        "Add `import logging` and `logger = logging.getLogger(__name__)` to src/interface/whatsapp_sender.py",
        "Add logger.debug() at start of send_text_message with extra={'operation': 'send_message_start'}",
        "Add logger.info() on successful send with extra={'operation': 'send_message_success', 'message_id': result.message_id}",
        "Add logger.warning() on rate limit with extra={'operation': 'send_rate_limited'}",
        "Add logger.error() on failure with extra={'operation': 'send_message_failed', 'error_type': type(e).__name__}",
        "Never log phone numbers - use structured extra dict only",
        "Example: Successful send logs info with message_id",
        "Negative case: Failed send logs error without exposing phone number"
      ],
      "startedAt": "2026-02-01T21:45:04.162354+00:00",
      "completedAt": "2026-02-01T21:50:04.808137+00:00",
      "updatedAt": "2026-02-01T21:50:04.807760+00:00"
    },
    {
      "id": "US-006",
      "title": "Remove PII from notification_service logs",
      "status": "done",
      "dependsOn": [],
      "description": "As a security-conscious developer, I want phone numbers removed from notification_service.py logs so that PII is not exposed in log files.",
      "acceptanceCriteria": [
        "Replace line 139: `logger.debug('Sending text verification message to %s', to_phone)` with `logger.debug('Sending text verification message', extra={'operation': 'verification_message_send'})`",
        "Replace line 102: `logger.info('Verification request sent to user=%s phone=%s', user_id, phone)` with `logger.info('Verification request sent', extra={'operation': 'verification_request_sent', 'user_id': user_id})`",
        "Replace line 194: `logger.info('Sent personal verification request to %s for chore...` - remove phone, keep chore title",
        "Replace line 244: `logger.info('Sent personal verification result to %s: %s', owner_phone, status)` - remove phone, keep status",
        "Example: Log output shows operation type without phone numbers",
        "Negative case: No phone number patterns (\\+\\d{10,}) appear in notification_service log calls"
      ],
      "startedAt": "2026-02-01T21:50:06.892312+00:00",
      "completedAt": "2026-02-01T21:56:50.380861+00:00",
      "updatedAt": "2026-02-01T21:56:50.380456+00:00"
    },
    {
      "id": "US-007",
      "title": "Remove PII from webhook.py logs",
      "status": "done",
      "dependsOn": [],
      "description": "As a security-conscious developer, I want phone numbers removed from webhook.py logs so that PII is not exposed.",
      "acceptanceCriteria": [
        "Update all logger calls in src/interface/webhook.py that include from_phone or phone numbers",
        "Replace `logger.info('Pending user %s sent message', message.from_phone)` with structured extra dict",
        "Replace `logger.info('Banned user %s sent message', message.from_phone)` with structured extra dict",
        "Replace `logger.info('Processing active user %s message with agent', message.from_phone)` similarly",
        "Replace `logger.error('Failed to send response to %s: %s', message.from_phone, result.error)` - keep error, remove phone",
        "Replace all other phone-logging instances identified in webhook.py (lines 132, 138, 144, 174, 176, 179, 337, 345, 365, 372, 385)",
        "Use extra={'user_status': status} or similar structured metadata instead",
        "Example: Logs show operation context without exposing phone numbers",
        "Negative case: grep for 'from_phone' in logger calls returns no matches"
      ],
      "startedAt": "2026-02-01T21:56:52.455049+00:00",
      "completedAt": "2026-02-01T22:00:20.927402+00:00",
      "updatedAt": "2026-02-01T22:00:20.927213+00:00"
    },
    {
      "id": "US-008",
      "title": "Remove PII from remaining service logs",
      "status": "done",
      "dependsOn": [],
      "description": "As a security-conscious developer, I want phone numbers removed from all remaining service modules so that PII is not exposed anywhere.",
      "acceptanceCriteria": [
        "Update src/services/personal_chore_service.py line 153 - remove owner_phone from log",
        "Update src/services/user_service.py lines 48, 66, 88, 140 - remove phone from logs",
        "Update src/core/scheduler.py line 479 - remove owner_phone from log",
        "Update src/services/session_service.py lines 52, 71, 103, 129, 137, 167, 210 - remove phone from logs",
        "Update src/services/personal_verification_service.py lines 91, 164 - remove phone from logs",
        "Update src/agents/choresir_agent.py lines 317, 323, 497, 517 - remove user_phone from logs",
        "Use structured extra={'operation': '...'} pattern consistently",
        "Example: All service logs use structured metadata without PII",
        "Negative case: grep -r 'phone' src/ --include='*.py' | grep logger shows no phone variable logging"
      ],
      "startedAt": "2026-02-01T22:00:23.025929+00:00",
      "completedAt": "2026-02-01T22:04:44.878851+00:00",
      "updatedAt": "2026-02-01T22:04:44.878396+00:00"
    },
    {
      "id": "US-009",
      "title": "Add return type hints to test methods",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want test methods to have proper return type hints so that the codebase passes type checking.",
      "acceptanceCriteria": [
        "Add `-> None` return type annotation to all test methods in tests/unit/test_whatsapp_sender.py class TestFormatPhoneForWaha (lines 70-84)",
        "Specifically: test_format_clean_number, test_format_with_plus, test_format_with_whatsapp_prefix, test_format_already_formatted",
        "Example: `def test_format_clean_number(self) -> None:`",
        "Negative case: ty check passes without type hint errors for these methods"
      ],
      "startedAt": "2026-02-01T22:04:46.971576+00:00",
      "completedAt": "2026-02-01T22:17:00.000000+00:00",
      "updatedAt": "2026-02-01T22:17:00.000000+00:00"
    },
    {
      "id": "US-010",
      "title": "Avoid redundant webhook parsing",
      "status": "done",
      "dependsOn": [],
      "description": "As a developer, I want webhook parsing to happen only once so that we avoid redundant processing.",
      "acceptanceCriteria": [
        "Modify _handle_webhook_error() in src/interface/webhook.py to accept optional parsed_message parameter",
        "Change signature to: `async def _handle_webhook_error(e: Exception, params: dict[str, Any], parsed_message: ParsedMessage | None = None) -> None`",
        "If parsed_message is None, parse once at start of function and reuse",
        "Remove the second parse_waha_webhook call at line 456",
        "Update call site in process_webhook_message to pass the already-parsed message",
        "Example: _handle_webhook_error called with pre-parsed message doesn't re-parse",
        "Negative case: Only one call to parse_waha_webhook exists in _handle_webhook_error",
        "Update any tests that mock _handle_webhook_error"
      ],
      "updatedAt": "2026-02-01T22:11:34.108899+00:00",
      "completedAt": "2026-02-01T22:11:34.109278+00:00",
      "startedAt": "2026-02-01T22:11:34.109280+00:00"
    },
    {
      "id": "US-011",
      "title": "Update existing tests for new changes",
      "status": "done",
      "dependsOn": [
        "US-003",
        "US-004",
        "US-005",
        "US-010"
      ],
      "description": "As a developer, I want all existing tests updated to work with the new code changes so that the test suite passes.",
      "acceptanceCriteria": [
        "Update tests/unit/test_webhook.py to mock HMAC validation or provide valid headers",
        "Update tests/unit/test_whatsapp_parser.py to include timestamp in all test payloads",
        "Update any integration tests that send webhook payloads to include valid HMAC headers",
        "Ensure all mocked settings include waha_webhook_hmac_key",
        "Example: pytest runs with all tests passing",
        "Negative case: No test failures related to missing HMAC or timestamp"
      ],
      "startedAt": "2026-02-01T22:11:36.186763+00:00",
      "completedAt": "2026-02-01T22:16:46.831634+00:00",
      "updatedAt": "2026-02-01T22:16:46.831300+00:00"
    }
  ]
}
