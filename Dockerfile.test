# Multi-stage build for minimal test container with PocketBase
FROM python:3.14-slim AS pocketbase-download

# Download PocketBase
RUN apt-get update && apt-get install -y wget unzip ca-certificates && \
    wget https://github.com/pocketbase/pocketbase/releases/download/v0.23.6/pocketbase_0.23.6_linux_amd64.zip && \
    unzip pocketbase_0.23.6_linux_amd64.zip && \
    chmod +x pocketbase && \
    rm pocketbase_0.23.6_linux_amd64.zip

# Final stage
FROM python:3.14-slim

WORKDIR /app

# Copy PocketBase binary from download stage
COPY --from=pocketbase-download /pocketbase /usr/local/bin/pocketbase

# Install uv for faster dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy project files
COPY pyproject.toml README.md* ./
COPY src/ src/
COPY tests/ tests/

# Create README.md if it doesn't exist (required by hatchling)
RUN touch README.md

# Install dependencies
RUN uv sync --all-extras

# Set test environment variables (these will be overridden by test fixtures)
ENV OPENROUTER_API_KEY="test_key" \
    WHATSAPP_VERIFY_TOKEN="test_verify" \
    WHATSAPP_APP_SECRET="test_secret" \
    WHATSAPP_ACCESS_TOKEN="test_access" \
    WHATSAPP_PHONE_NUMBER_ID="test_phone_id" \
    LOGFIRE_TOKEN="test_logfire" \
    HOUSE_CODE="TEST123" \
    HOUSE_PASSWORD="testpass"

# Run tests
CMD ["uv", "run", "pytest", "tests/", "-v"]
